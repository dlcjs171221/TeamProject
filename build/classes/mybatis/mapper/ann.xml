<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ann">

<resultMap type="mybatis.vo.AnnVO" id="map1">
	<id property="a_idx" column="a_idx"/>
	<collection property="a_list" ofType="mybatis.vo.ACommVO"
		column="a_idx" select="acommlist"/>
</resultMap>    
 

<!-- 특정 원글들의 기본키를 조건으로 하여
		해당 댓글들을 조회하는 기능 -->
<select id="acommlist" resultType="mybatis.vo.ACommVO"
	parameterType="String">
		select * from acomment_t
		where a_idx = #{a_idx}
	</select>



<!-- 사용자가 원글의 목록을 만들기 위해 호출하는 기능 -->
<select id="annlist" parameterType="java.util.Map"
resultMap="map1">
	SELECT * FROM(
			SELECT rownum r_num, a.* FROM(
				SELECT * FROM ann_t
				WHERE status = 0
				ORDER BY a_idx DESC
			) a
		) WHERE r_num BETWEEN #{begin} AND #{end}
		
</select>


<!-- 전체 게시물 수 -->
<select id="totalCount" resultType="int">
	select count(*) from ann_t
	where status = 0
</select>

<!-- 원글 저장하는 기능(추가) -->
<insert id="add" parameterType="java.util.Map">
	insert into ann_t(a_idx, subject, writer, content, file_name, 
			ori_name, pwd, write_date, ip, hit, status)
		values(ann_t_seq.nextval, #{subject}, #{writer}, #{content}, #{file_name}, 
			#{ori_name}, #{pwd}, sysdate, #{ip}, #{hit}, #{status})
</insert>

<!-- 보기 기능 :
		기본키(a_idx)를 인자로 받아 조건으로 부여하여 
		원글을 검색한다. -->
	<select id="getAnn" parameterType="String"
	resultMap="map1">
		select * from ann_t
		where a_idx = #{a_idx}
	</select>
	
<!-- 댓글 저장하는 기능 -->
	<insert id="add_ans" parameterType="mybatis.vo.ACommVO">
		insert into acomment_t(c_idx, writer, content, pwd, write_date,
			ip, a_idx)
		values(acomment_t_seq.nextval, #{writer}, #{content}, #{pwd}, sysdate, 
		#{ip}, #{a_idx})
	</insert>
	
<!-- 원글 수정 -->
	<update id="edit" parameterType="java.util.Map">
		update ann_t
		set subject = #{subject},
			writer = #{writer},
			ip = #{ip},
			content = #{content}
			<if test="fname != null">
			,file_name = #{f_name}
			,ori_name = #{o_name}
			</if>
			where a_idx = #{a_idx} and pwd =#{pwd}
	</update>

<!-- 원글 삭제 -->
	<update id="del" parameterType="java.util.Map">
		update ann_t
		set 
			status = 1
		where a_idx = #{a_idx} and pwd =#{pwd}
		
	</update>	

<!-- 조회수 증가 -->
	<update id="hit" parameterType="String">
		update ann_t
		set hit = hit+1
		where a_idx = #{a_idx}
	</update>


</mapper>